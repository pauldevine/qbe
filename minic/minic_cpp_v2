#!/bin/bash
# MiniC Preprocessor Wrapper v2
# Uses standard cpp (without -traditional-cpp) for better compatibility
#
# Usage: minic_cpp_v2 input.c output.ssa
#        minic_cpp_v2 input.c          (outputs to stdout)

set -e
set -o pipefail  # Fail on any pipe stage failure

INPUT="$1"
OUTPUT="$2"

if [ -z "$INPUT" ]; then
    echo "Usage: $0 input.c [output.ssa]" >&2
    echo "" >&2
    echo "Preprocesses C source with cpp and compiles with MiniC" >&2
    echo "" >&2
    echo "Examples:" >&2
    echo "  $0 program.c program.ssa    # Preprocess and compile to file" >&2
    echo "  $0 program.c | qbe          # Pipe directly to QBE" >&2
    exit 1
fi

if [ ! -f "$INPUT" ]; then
    echo "Error: File '$INPUT' not found" >&2
    exit 1
fi

# Get the directory of this script to find minic
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MINIC="$SCRIPT_DIR/minic"

if [ ! -x "$MINIC" ]; then
    echo "Error: minic not found or not executable at $MINIC" >&2
    echo "Run 'make' in $SCRIPT_DIR first" >&2
    exit 1
fi

# Preprocess with cpp (standard mode), normalize types, strip function return types, then compile
# -P: Don't generate #line directives
#
# Type normalization:
# - Remove redundant 'int' from various type combinations
# - Remove 'signed' keyword (MiniC doesn't support it)
# - Must be careful not to break 'unsigned' into 'un'!
# - Order matters: do specific patterns first, general patterns last
NORMALIZE_TYPES='
s/\bunsigned short int\b/unsigned short/g
s/\bunsigned long int\b/unsigned long/g
s/\bsigned short int\b/short/g
s/\bsigned long int\b/long/g
s/\blong long int\b/long long/g
s/\blong int\b/long/g
s/\bshort int\b/short/g
s/\bsigned char\b/char/g
s/\bsigned short\b/short/g
s/\bsigned long long\b/long long/g
s/\bsigned long\b/long/g
s/\bsigned int\b/int/g
s/\bsigned\b//g
'

# Function return type stripping:
# Transform "type funcname(" to "funcname(" for function definitions
STRIP_TYPES='
s/^[ \t]*void[ \t]\+\([a-zA-Z_][a-zA-Z0-9_]*\)[ \t]*(/\1(/
s/^[ \t]*int[ \t]\+\([a-zA-Z_][a-zA-Z0-9_]*\)[ \t]*(/\1(/
s/^[ \t]*long[ \t]\+\([a-zA-Z_][a-zA-Z0-9_]*\)[ \t]*(/\1(/
s/^[ \t]*char[ \t]\+\([a-zA-Z_][a-zA-Z0-9_]*\)[ \t]*(/\1(/
s/^[ \t]*short[ \t]\+\([a-zA-Z_][a-zA-Z0-9_]*\)[ \t]*(/\1(/
s/^[ \t]*unsigned[ \t]\+[a-z]\+[ \t]\+\([a-zA-Z_][a-zA-Z0-9_]*\)[ \t]*(/\1(/
s/^[ \t]*uint[0-9]\+_t[ \t]\+\([a-zA-Z_][a-zA-Z0-9_]*\)[ \t]*(/\1(/
s/^[ \t]*int[0-9]\+_t[ \t]\+\([a-zA-Z_][a-zA-Z0-9_]*\)[ \t]*(/\1(/
s/^[ \t]*__uint[0-9]\+_t[ \t]\+\([a-zA-Z_][a-zA-Z0-9_]*\)[ \t]*(/\1(/
s/^[ \t]*__int[0-9]\+_t[ \t]\+\([a-zA-Z_][a-zA-Z0-9_]*\)[ \t]*(/\1(/
s/^[ \t]*size_t[ \t]\+\([a-zA-Z_][a-zA-Z0-9_]*\)[ \t]*(/\1(/
s/^[ \t]*bool[ \t]\+\([a-zA-Z_][a-zA-Z0-9_]*\)[ \t]*(/\1(/
'

if [ -z "$OUTPUT" ]; then
    # Output to stdout
    cpp -P "$INPUT" | sed "$NORMALIZE_TYPES" | sed "$STRIP_TYPES" | "$MINIC"
else
    # Output to file
    cpp -P "$INPUT" | sed "$NORMALIZE_TYPES" | sed "$STRIP_TYPES" | "$MINIC" > "$OUTPUT"
fi
